<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>CidadeSomosNós – Arquivo de Posts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 1rem; background: #f5f5f5; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    h1 { margin: 0; font-size: 1.5rem; }
    button { padding: 0.5rem 1rem; border-radius: 4px; border: none; cursor: pointer; }
    #create-post-btn { background: #2563eb; color: white; }
    #post-form-container { display: none; margin-bottom: 1rem; background: white; padding: 1rem; border-radius: 8px; }
    label { display: block; margin-top: 0.5rem; font-size: 0.9rem; }
    input, textarea { width: 100%; padding: 0.4rem; margin-top: 0.25rem; box-sizing: border-box; }
    textarea { min-height: 100px; }
    .post-card { background: white; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; }
    .post-title { font-weight: bold; margin-bottom: 0.25rem; }
    .post-meta { font-size: 0.8rem; color: #666; margin-bottom: 0.5rem; }
    .post-image { max-width: 100%; border-radius: 8px; margin: 0.5rem 0; }
    .links { font-size: 0.85rem; margin-top: 0.5rem; }
    .links a { color: #2563eb; text-decoration: none; }
    .links a:hover { text-decoration: underline; }
    #posts-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 8px;
    }

    .post-thumb {
      position: relative;
      width: 100%;
      aspect-ratio: 1 / 1; /* quadradinho estilo insta */
      overflow: hidden;
      border-radius: 8px;
      background: #ddd;
      cursor: pointer;
    }

    .post-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .post-thumb video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #post-detail {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #post-detail-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
    }

    #post-detail-card {
      position: relative;
      background: #fff;
      border-radius: 12px;
      max-width: 900px;
      width: 95%;
      max-height: 90vh;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      z-index: 1001;
    }

    #post-detail-media-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    #post-detail-media img,
    #post-detail-media video {
      max-width: 100%;
      max-height: 60vh;
      border-radius: 8px;
    }

    .carousel-btn {
      border: none;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
    }

    .carousel-btn:disabled {
      opacity: 0.3;
      cursor: default;
    }

    #post-detail-info {
      font-size: 0.9rem;
    }
  </style>
</head>

<body>
  <header>
    <h1>CidadeSomosNós – Arquivo de Posts</h1>
    <button id="create-post-btn">CRIAR POST</button>
  </header>

  <section id="post-form-container">
    <h2>Novo Post</h2>
    <form id="post-form" enctype="multipart/form-data">
      <label>Título
        <input type="text" name="title" required />
      </label>

      <label>Texto
        <textarea name="content" required></textarea>
      </label>

      <label>Mídias (imagens e vídeos)
        <input type="file" name="media" accept="image/*,video/*" multiple required />
      </label>


      <label>Data de publicação no Instagram
        <input type="date" name="published_at" required />
      </label>

      <label>URL do post no Instagram (opcional)
        <input type="url" name="instagram_url" />
      </label>

      <div style="margin-top:0.75rem;">
        <button type="submit">Publicar</button>
        <button type="button" id="cancel-btn">Cancelar</button>
      </div>
    </form>
  </section>

  <section id="posts-container"></section>

  <section id="post-detail" style="display:none;">
    <div id="post-detail-backdrop"></div>
    <div id="post-detail-card">
      <div id="post-detail-media-container">
        <button id="prev-media-btn" class="carousel-btn">&#10094;</button>
        <div id="post-detail-media"></div>
        <button id="next-media-btn" class="carousel-btn">&#10095;</button>
      </div>
      <div id="post-detail-info"></div>
      <button id="close-detail-btn">Fechar</button>
    </div>
  </section>

  
  <script>
    const createBtn = document.getElementById("create-post-btn");
    const formContainer = document.getElementById("post-form-container");
    const cancelBtn = document.getElementById("cancel-btn");
    const form = document.getElementById("post-form");
    const postsContainer = document.getElementById("posts-container");

    const postDetailSection = document.getElementById("post-detail");
    const postDetailBackdrop = document.getElementById("post-detail-backdrop");
    const postDetailMedia = document.getElementById("post-detail-media");
    const postDetailInfo = document.getElementById("post-detail-info");
    const closeDetailBtn = document.getElementById("close-detail-btn");
    const prevMediaBtn = document.getElementById("prev-media-btn");
    const nextMediaBtn = document.getElementById("next-media-btn");

    let postsCache = [];
    let currentPost = null;
    let currentMediaIndex = 0;

    function toggleForm(show) {
      formContainer.style.display = show ? "block" : "none";
    }

    function toggleDetail(show) {
      postDetailSection.style.display = show ? "flex" : "none";
    }

    createBtn?.addEventListener("click", () => toggleForm(true));
    cancelBtn?.addEventListener("click", () => toggleForm(false));

    closeDetailBtn.addEventListener("click", () => toggleDetail(false));
    postDetailBackdrop.addEventListener("click", () => toggleDetail(false));

    prevMediaBtn.addEventListener("click", () => {
      if (!currentPost) return;
      if (currentMediaIndex > 0) {
        currentMediaIndex--;
        renderCurrentMedia();
      }
    });

    nextMediaBtn.addEventListener("click", () => {
      if (!currentPost) return;
      if (currentMediaIndex < currentPost.midias.length - 1) {
        currentMediaIndex++;
        renderCurrentMedia();
      }
    });

    async function loadPosts() {
      const res = await fetch("/api/posts");
      const posts = await res.json();
      postsCache = posts;
      renderPostsGrid(posts);
    }

    function renderPostsGrid(posts) {
      postsContainer.innerHTML = "";
      if (!posts.length) {
        postsContainer.innerHTML = "<p>Não há posts ainda.</p>";
        return;
      }

      posts.forEach(post => {
        const midias = post.midias || [];
        if (!midias.length) {
          return; // sem mídia nenhuma, ignora
        }

        // tenta usar imagem; se não tiver, usa o primeiro vídeo
        const capa =
          midias.find(m => m.tipo === "image") ||
          midias[0];

        const div = document.createElement("div");
        div.className = "post-thumb";

        // ao clicar, abre o detalhe começando nessa mídia
        div.addEventListener("click", () => {
          openPostDetail(post.id, capa.id);
        });

        if (capa.tipo === "video") {
          const video = document.createElement("video");
          video.src = capa.file_path;
          video.muted = true;
          video.loop = true;
          video.autoplay = true;
          video.playsInline = true;
          div.appendChild(video);
        } else {
          const img = document.createElement("img");
          img.src = capa.file_path;
          img.alt = post.title || "";
          div.appendChild(img);
        }

        postsContainer.appendChild(div);
      });
    }

    function openPostDetail(postId, midiaId) {
      const post = postsCache.find(p => p.id === postId);
      if (!post) return;

      currentPost = post;
      let idx = 0;
      if (midiaId != null) {
        const foundIndex = post.midias.findIndex(m => m.id === midiaId);
        if (foundIndex >= 0) idx = foundIndex;
      }
      currentMediaIndex = idx;

      renderPostDetail();
      toggleDetail(true);
    }

    function renderPostDetail() {
      if (!currentPost) return;

      const publishedAt = new Date(currentPost.published_at);

      postDetailInfo.innerHTML = `
        <div class="post-title">${currentPost.title || ""}</div>
        <div class="post-meta">
          Publicado em: ${publishedAt.toLocaleDateString("pt-BR")}
        </div>
        <div style="margin:0.5rem 0;">
          ${ (currentPost.content || "").replace(/\n/g, "<br>") }
        </div>
        <div class="links">
          ${ currentPost.instagram_url ? `<a href="${currentPost.instagram_url}" target="_blank">Ver no Instagram</a>` : "" }
        </div>
      `;

      renderCurrentMedia();
    }

    function renderCurrentMedia() {
      postDetailMedia.innerHTML = "";
      if (!currentPost || !currentPost.midias || !currentPost.midias.length) return;

      const midia = currentPost.midias[currentMediaIndex];

      let mediaElement;
      if (midia.tipo === "video") {
        mediaElement = document.createElement("video");
        mediaElement.controls = true;
        mediaElement.preload = "metadata";

        const source = document.createElement("source");
        source.src = midia.file_path;
        mediaElement.appendChild(source);
      } else {
        mediaElement = document.createElement("img");
        mediaElement.src = midia.file_path;
      }

      postDetailMedia.appendChild(mediaElement);

      // habilita/desabilita botões do carrossel
      prevMediaBtn.disabled = currentMediaIndex === 0;
      nextMediaBtn.disabled = currentMediaIndex === currentPost.midias.length - 1;
    }

    // envio do formulário para criar posts (se você já estiver usando isso)
    form?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(form);

      const res = await fetch("/api/posts", {
        method: "POST",
        body: formData,
      });

      if (res.ok) {
        form.reset();
        toggleForm(false);
        loadPosts();
      } else {
        alert("Erro ao criar post");
      }
    });

    loadPosts();
  </script>


</body>
</html>
